---
- name: Add group "zookeeper"
  group: name={{ zookeeper_group }} system=yes

- name: Add user "zookeeper"
  user: name={{ zookeeper_group }} group={{ zookeeper_group }} home={{ zookeeper_data_dir }} shell=/sbin/nologin system=yes

- name: Download the tarball
  get_url: url=http://{{ zookeeper_mirror }}/zookeeper/zookeeper-{{ zookeeper_version }}/apache-zookeeper-{{ zookeeper_version }}-bin.tar.gz dest=/opt/zookeeper-{{ zookeeper_version }}-bin.tar.gz

- name: Extract the tarball
  unarchive: src=/opt/zookeeper-{{ zookeeper_version }}-bin.tar.gz dest=/opt/ copy=no creates=/opt/zookeeper-{{ zookeeper_version }}-bin

- name: Symlink install directory
  file:
    src: /opt/apache-zookeeper-{{ zookeeper_version }}-bin
    path: /opt/zookeeper
    state: link

- name: Set correct ownership to extracted ZooKeeper directory
  file:
    path: /opt/apache-zookeeper-{{ zookeeper_version }}-bin
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
    recurse: yes

- name: Set correct ownership to ZooKeeper symlink
  file:
    path: /opt/zookeeper
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
    state: link

- name: Create Zookeeper data directory
  file:
    path: "{{ zookeeper_data_dir }}"
    state: directory
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"

- name: Create Zookeeper log directory
  file:
    path: "{{ zookeeper_log_dir }}"
    state: directory
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"

- name: Create Zookeeper conf directory
  file:
    path: "{{ zookeeper_conf_dir }}"
    state: directory
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
    mode: "0755"

- name: Install systemd unit for ZooKeeper
  template:
    src: zookeeper.service.j2
    dest: /etc/systemd/system/zookeeper.service
    mode: '0644'
  notify:
    - Reload systemd
    - Restart zookeeper

- name: Configure Zookeeper server
  template: 
    src: zookeeper.conf.j2 
    dest: "{{zookeeper_conf_dir}}/zoo.cfg"
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
  notify: Restart zookeeper

- name: Configure myid
  template:
    src: myid.j2
    dest: "{{ zookeeper_data_dir }}/myid"
    owner: "{{ zookeeper_user }}"
    group: "{{ zookeeper_group }}"
  vars:
    id: "{{ groups['kafka_masters'].index(inventory_hostname) + 1 }}"
  notify: Restart zookeeper

- name: Ensure ZooKeeper is enabled
  systemd:
    name: zookeeper
    enabled: yes
